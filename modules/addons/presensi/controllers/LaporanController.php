<?php
/**
 * presensi-siswa
 * LaporanController.php
 * Author: DwiAgus
 * Email : dwiagus@uny.ac.id
 * Date  : 10/07/2020
 * Time  : 20:09
 */

namespace Modules\Presensi\Controllers;


use Modules\History\Models\History;
use Modules\Kelas\Models\Kelas;
use Modules\Presensi\Models\Presensi;
use Modules\Presensi\Plugin\Helper;
use Modules\Tahunajaran\Models\Tahunajaran;

class LaporanController extends \Modules\Frontend\Controllers\ControllerBase
{
    /**
     * @var \Phalcon\Mvc\Model\ResultsetInterface|void
     */
    private $tahun;
    /**
     * @var \Phalcon\Mvc\Model\ResultsetInterface|void
     */
    private $kelas;

    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->tahun = Tahunajaran::find();
        $this->kelas = Kelas::find("status='1'");
        $this->assets
            ->collection('footer')
            ->setTargetPath("themes/admin/assets/js/combined-presensi-laporan.js")
            ->setTargetUri("themes/admin/assets/js/combined-presensi-laporan.js")
            ->join(true)
            ->addJs($this->config->application->addonsDir."presensi/views/js/laporan.js")
            ->addFilter(new \Phalcon\Assets\Filters\Jsmin());
    }

    public function indexAction()
    {

    }

    public function search_harianAction()
    {
        $this->view->disable();
        if ($this->request->isPost() == true)
        {
            $kelas = $this->request->getPost("kelas");
            $tahun = $this->request->getPost("tahun_ajaran");
            $tanggal = $this->request->getPost("tanggal");
            $presensi = Presensi::find([
                'conditions' => 'kelas= ?1 AND tahun_ajaran= ?2 AND tanggal= ?3',
                'bind' => [
                    1 => $kelas,
                    2 => $tahun,
                    3 => $tanggal
                ]
            ]);
            $response = new \Phalcon\Http\Response();
            $response->setContentType('application/json', 'UTF-8');
            $response->setJsonContent($presensi);
            return $response->send();
        }
    }

    public function search_bulananAction()
    {
        $this->view->disable();
        $kelas = $this->request->getPost('kelas');
        $tahun = $this->request->getPost('tahun_ajaran');
        $bulan = $this->request->getPost('bulan');
        $mode  = '0';
        $history = History::find([
            'conditions' => "kelas= ?1 AND tahun= ?2",
            'bind' => [
                1 => $kelas,
                2 => $tahun
            ]
        ]);
        $arr = array();
        foreach ($history as $siswa)
        {
            $arr[] = [
                'nisn' => $siswa->nisn,
                'nama' => $siswa->nama,
                'sex'  => $siswa->sex,
                'presensi' => $siswa->getPresensi(
                    ['conditions' => "kelas = '{$kelas}' AND tahun_ajaran='{$tahun}' AND DATE_FORMAT(tanggal,'%m-%Y') = '{$bulan}' "]),
            ];
        }
//        $response = new \Phalcon\Http\Response();
//        $response->setContentType('application/json', 'UTF-8');
//        $response->setJsonContent($arr);
//        return $response->send();
        echo $this->bulanan($arr);
    }

    public function bulanan($arr)
    {
        $bt ='06-2020';

        $start = Helper::firstday($bt);
        $end = Helper::lastDay($bt);
        $work = Helper::workingDay($start,$end);
        $html = "";
        $html .= "<table id=\"grid-izin-presensi\" class=\"table table-condensed table-hover table-striped\">";
        $html .= "<thead>";
        $html .= "<tr>";
        $html .= "<th rowspan='2' valign='top'>Nama</th>";
        $html .= "<th rowspan='2' valign='top'>NIS</th>";
        $html .= "<th rowspan='2' valign='top'>JK</th>";
        $html .= "<th colspan='".count($work)."'>TANGGAL</th>";
        $html .= "<th colspan='3'>JUMLAH</th>";
        $html .= "<th rowspan='2' valign='top'>KET</th>";
        $html .= "</tr>";
        $html .= "<tr>";
        foreach ($work as $k => $item) {
            list($y,$m,$d) = explode("-",$item);
            $html .= "<th>".$d."</th>";
        }
        $html .= "<th rowspan='2'>I</th>";
        $html .= "<th rowspan='2'>S</th>";
        $html .= "<th rowspan='2'>A</th>";
        $html .= "</tr>";
        $html .= "</thead>";
        $html .= "<tbody>";
        foreach ($arr as $item) {
            $html .= "<tr>";
            $html .= "<td>".$item['nama']."</td>";
            $html .= "<td>".$item['nisn']."</td>";
            $html .= "<td>".$item['sex']."</td>";
            $izin = 0;
            $sakit= 0;
            $hadir= 0;
            foreach ($work as $k => $wk) {
                $html .= "<td>";
                foreach ($item['presensi'] as $pres) {
                    if ($pres->tanggal == $wk)
                    {
                        if($pres->status == '1' || $pres->status == '2'){
                            $html .= date('H:m:s',strtotime($pres->jam_masuk)) ."<br>";
                        }
                        if($pres->status == '3')
                        {
                            $izin +=1;
                            $html .="I";
                        }
                        if($pres->status == '4')
                        {
                            $sakit +=1;
                            $html .="S";
                        }
                        $hadir +=1;
                    }

                }
                $html .= "</td>";
            }
            $alpha= count($work)-$hadir;
            $html .= "<td>{$izin}</td>";
            $html .= "<td>{$sakit}</td>";
            $html .= "<td>{$alpha}</td>";
            $html .= "<td></td>";
            $html .= "</tr>";
        }
        $html .= "</tbody>";
        $html .="</table>";
        return $html;
    }

    public function harianAction()
    {
        $this->view->setVar('kelas',$this->kelas);
        $this->view->setVar('tahun',$this->tahun);
        $this->view->pick("laporan_harian");
    }

    public function bulananAction()
    {
        $this->view->setVar('kelas',$this->kelas);
        $this->view->setVar('tahun',$this->tahun);
        $this->view->pick("laporan_bulanan");
    }

    public function cetak_bulananAction()
    {

    }

    public function cetak_harianAction()
    {

    }
}